const w=["script","style","noscript"],C=["base","meta","link","style","script","noscript"],R=["base","title","titleTemplate","bodyAttrs","htmlAttrs"];function H(r,i){const{props:a,tag:t}=r;if(R.includes(t))return t;if(t==="link"&&a.rel==="canonical")return"canonical";if(a.charset)return"charset";const s=["id"];t==="meta"&&s.push("name","property","http-equiv");for(const l of s)if(typeof a[l]<"u"){const c=String(a[l]);return i&&!i(c)?!1:`${t}:${l}:${c}`}return!1}const b=(r,i)=>{const{tag:a,$el:t}=r;t&&(Object.entries(a.props).forEach(([s,l])=>{l=String(l);const c=`attr:${s}`;if(s==="class"){if(!l)return;for(const u of l.split(" ")){const p=`${c}:${u}`;i&&i(r,p,()=>t.classList.remove(u)),t.classList.contains(u)||t.classList.add(u)}return}i&&!s.startsWith("data-h-")&&i(r,c,()=>t.removeAttribute(s)),t.getAttribute(s)!==l&&t.setAttribute(s,l)}),w.includes(a.tag)&&t.innerHTML!==(a.children||"")&&(t.innerHTML=a.children||""))};function I(r){let i=9;for(let a=0;a<r.length;)i=Math.imul(i^r.charCodeAt(a++),9**9);return((i^i>>>9)+65536).toString(16).substring(1,8).toLowerCase()}async function M(r,i={}){var _,E;const a={shouldRender:!0};if(await r.hooks.callHook("dom:beforeRender",a),!a.shouldRender)return;const t=i.document||window.document,s=r._popSideEffectQueue();r.headEntries().map(n=>n._sde).forEach(n=>{Object.entries(n).forEach(([e,o])=>{s[e]=o})});const l=async n=>{const e=r.headEntries().find(g=>g._i===n._e),o={renderId:n._d||I(JSON.stringify({...n,_e:void 0,_p:void 0})),$el:null,shouldRender:!0,tag:n,entry:e,staleSideEffects:s};return await r.hooks.callHook("dom:beforeRenderTag",o),o},c=[],u={body:[],head:[]},p=(n,e,o)=>{e=`${n.renderId}:${e}`,n.entry&&(n.entry._sde[e]=o),delete s[e]},m=n=>{r._elMap[n.renderId]=n.$el,c.push(n),p(n,"el",()=>{var e;(e=n.$el)==null||e.remove(),delete r._elMap[n.renderId]})};for(const n of await r.resolveTags()){const e=await l(n);if(!e.shouldRender)continue;const{tag:o}=e;if(o.tag==="title"){t.title=o.children||"",c.push(e);continue}if(o.tag==="htmlAttrs"||o.tag==="bodyAttrs"){e.$el=t[o.tag==="htmlAttrs"?"documentElement":"body"],b(e,p),c.push(e);continue}if(e.$el=r._elMap[e.renderId],!e.$el&&o._hash&&(e.$el=t.querySelector(`${(_=o.tagPosition)!=null&&_.startsWith("body")?"body":"head"} > ${o.tag}[data-h-${o._hash}]`)),e.$el){e.tag._d&&b(e),m(e);continue}e.$el=t.createElement(o.tag),b(e),u[(E=o.tagPosition)!=null&&E.startsWith("body")?"body":"head"].push(e)}Object.entries(u).forEach(([n,e])=>{var g;if(!e.length)return;const o=(g=t==null?void 0:t[n])==null?void 0:g.children;if(o){for(const d of[...o].reverse()){const A=d.tagName.toLowerCase();if(!C.includes(A))continue;const T=H({tag:A,props:d.getAttributeNames().reduce((f,h)=>({...f,[h]:d.getAttribute(h)}),{})}),y=e.findIndex(f=>{var h;return f&&(f.tag._d===T||((h=d.isEqualNode)==null?void 0:h.call(d,f.$el)))});if(y!==-1){const f=e[y];f.$el=d,b(f),m(f),delete e[y]}}e.forEach(d=>{if(d.$el){switch(d.tag.tagPosition){case"bodyClose":t.body.appendChild(d.$el);break;case"bodyOpen":t.body.insertBefore(d.$el,t.body.firstChild);break;case"head":default:t.head.appendChild(d.$el);break}m(d)}})}});for(const n of c)await r.hooks.callHook("dom:renderTag",n);Object.values(s).forEach(n=>n())}let $=null;async function O(r,i={}){function a(){return $=null,M(r,i)}const t=i.delayFn||(s=>setTimeout(s,10));return $=$||new Promise(s=>t(()=>s(a())))}export{O as d,M as r};
